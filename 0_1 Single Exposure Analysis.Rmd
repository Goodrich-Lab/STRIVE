---
title: 'STRIVE'
subtitle: "Final Analysis"
author: "Hongxu Wang"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    code_folding: hide
editor_options: 
  chunk_output_type: console
---
```{r setup univariate analysis pfas, include=FALSE, echo=FALSE}
options(knitr.table.format = "html")
knitr::opts_chunk$set(echo = TRUE,warning=FALSE, message = FALSE, cache=FALSE,collapse=FALSE)

source(fs::path(here::here("!libraries.R")))
source(fs::path(here::here("!directories.R")))
# source(fs::path(here::here("functions.R")))
source(fs::path(here::here("!load_cleaned_data.R")))
```

## Simple linear or logistic regression

**Exposure: normalized pfas**

**Covars (included sig vars found in exposure correlation, also excluding some vars): source (both), sex (both), age_at_enrollment (exposure), smoking (exposure), sq_average_drink_per_day (exposure)**

*sig vars from exposure correlation: 'age_at_enrollment','sex','bmi','sq_drink_alcohol','sq_average_drink_per_day', 'smoking','sq_water_bottled','sq_water_other_type', 'sq_water_faucet_filter','source_UNC','source_DUKE','source_Emory','source_NCSU'
*sig vars from exposure correlation:'sex', 'source (reference: Emory)','trig_mg_d_l'

**Outcome: natural log ALT, natural log AST, alt_cat1, ast_cat1, alt_cat2, ast_cat2**

*alt_cat1/ast_cat1: Norm: <= 29IU/L(males), <= 19IU/L(females); High: > 29IU/L(males), > 19IU/L(females)

*alt_cat2/ast_cat2: Norm: <= 33IU/L(males), <= 25IU/L(females); High: > 33IU/L(males), > 25IU/L(females)
**Analysis: linear regression/logistic regression**

```{r analysis alt ast endpoints}
# Perform linear regression using epiomics package
## outcome: natural log alt, natural log ast
covars <- c("source", "sex", "age_at_enrollment", "smoking", "sq_average_drink_per_day")

con_end <-c("log_alt", "log_ast")
con_end1 <-c("alt_cat1", "alt_cat2", "ast_cat1", "ast_cat2")

res_cont <- epiomics::owas(data,
                      var = con_end,  
                      omics = pfas_name_scld,
                      covars = covars,
                      var_exposure_or_outcome = "outcome",  
                      family = "gaussian",  # Use "gaussian" for linear regression
                      conf_int = TRUE)
## outcome: alt_cat1, ast_cat1, alt_cat2, ast_cat2
res_cat <- epiomics::owas(data,
                      var = con_end1, 
                      omics = pfas_name_scld,
                      covars = covars,
                      var_exposure_or_outcome = "outcome",  
                      family = "binomial", 
                      conf_int = TRUE,
                      ref_group = "Normal")
res <- res_cont %>% mutate(outcome_type = "continuous") %>%
  bind_rows(res_cat %>% mutate(outcome_type ="categorical"))

# Adding sig variable to indicate the significance and rename PFAS
res1 <- res %>%
  mutate(sig = case_when((p_value < 0.05 & adjusted_pval < 0.05) ~ "Sig.(FDR < 0.05)",
                         p_value < 0.05 ~ "Sig.(p value < 0.05)", 
                         TRUE ~ "Not Sig.")) %>%
  mutate(plot_name = case_when(
    grepl("pfba", feature_name) ~ "PFBA",
    grepl("pf_hp_a", feature_name) ~ "PFHpA",
    grepl("pf_pe_s", feature_name) ~ "PFPeS",
    grepl("pfbs", feature_name) ~ "PFBS",
    grepl("pf_hx_a", feature_name) ~ "PFHxA",
    grepl("pf_do_a", feature_name) ~ "PFDoA",
    grepl("pfda", feature_name) ~ "PFDA",
    grepl("pf_pe_a", feature_name) ~ "PFPeA",
    grepl("pf_un_a", feature_name) ~ "PFUnA",
    grepl("pfna", feature_name) ~ "PFNA",
    grepl("pfos", feature_name) ~ "PFOS",
    grepl("pf_hx_s", feature_name) ~ "PFHxS",
    grepl("pf_hp_s", feature_name) ~ "PFHpS",
    grepl("pfoa", feature_name) ~ "PFOA",
    grepl("pf3ons", feature_name) ~ "9CL-PF3ONS"
  ))%>%
  mutate(group = ifelse(feature_name %in% legacy_scld, "Legacy", "Emerging"))

res1$var_name<-factor(res1$var_name, levels=c("log_alt", "log_ast", "alt_cat1", "alt_cat2", "ast_cat1", "ast_cat2"), labels=c("natural log alt", "natural log ast", "lowest cut alt", "highest cut alt", "lowest cut ast", "highest cut ast"))

# Plot coefficients and confidence intervals----
## continuous alt and ast related outcomes
(plot1 <- ggplot(res1 %>% filter(outcome_type =="continuous"), aes(x = estimate, y = fct_reorder(plot_name, estimate), color = sig)) +
  geom_errorbar(aes(xmin = conf_low, xmax = conf_high), width = 0, position = position_dodge(width = 1)) +
  geom_point(size = 1, position = position_dodge(width = 1)) + 
  geom_vline(xintercept = 0, linetype = 2, color = "grey") +  
  facet_grid(group ~ var_name, scales = "free", space = "free_y") +
  labs(
    title = "Effect of each PFAS on natural log of ALT and AST",
    x = "Coefficient (95% CI)", y= "PFAS") +
  theme(
    legend.position = "bottom",
    panel.background = element_rect(fill="white"), 
    strip.background = element_rect(fill = "white"),
    strip.text.y = element_text(angle = 0, hjust = 0),
    text = element_text(size = 15),
    axis.title.y = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    plot.title = element_text(size = 15, hjust = 0.5) 
  ) +
  scale_color_manual(values = c("black", "red")))

## categorical alt and ast related outcomes----
(plot2 <- ggplot(res1 %>% filter(outcome_type =="categorical"), aes(x = exp(estimate), y = fct_reorder(plot_name, estimate), color = sig)) +
  geom_errorbar(aes(xmin = exp(conf_low), xmax = exp(conf_high)), width = 0, position = position_dodge(width = 1)) +
  geom_point(size = 1, position = position_dodge(width = 1)) + 
  geom_vline(xintercept = 1, linetype = 2, color = "grey") +  
  facet_grid(group ~ var_name, scales = "free", space = "free_y") +
  labs(
    title = "Effect of each PFAS on categorized ALT and AST",
    x = "Odds Ratio (95% CI)", y= "PFAS") +
  theme(
    legend.position = "bottom",
    panel.background = element_rect(fill="white"), 
    strip.background = element_rect(fill = "white"),
    strip.text.y = element_text(angle = 0, hjust = 0),
    text = element_text(size = 15),
    axis.title.y = element_blank(),
    axis.line.x = element_line(color = "black"),
    axis.line.y = element_line(color = "black"),
    plot.title = element_text(size = 15, hjust = 0.5) 
  ) +
  scale_color_manual(values = c("black", "red")))

writexl::write_xlsx(res1, fs::path(dir_result, "pfas_alt_ast.xlsx"))

```

#Tables: Adjusted associations of individual PFAS and outcomes
```{r association of PFAS and outcome}
res <- readxl::read_xlsx(fs::path(dir_result,"pfas_alt_ast.xlsx"))%>%
  dplyr::select(var_name, plot_name, group, estimate:sig) %>%
  mutate(across(where(is.numeric), ~ round(., 3)))

res %>%
  filter(var_name == "natural log alt") %>%
  dplyr::select(plot_name, estimate, se, test_statistic, 
                p_value, adjusted_pval,conf_low, conf_high)%>%
  gt() %>%
  tab_header(
    title = "Associations between exposures and ALT From Simple LR"
  ) %>%
  cols_label(
    plot_name = "PFAS",
    estimate = "Estimate",
    se = "Standard Error",
    test_statistic = "Statistic",
    p_value = "P-value",
    adjusted_pval = "Adjusted P-value",
    conf_low = "Lower CI",
    conf_high = "Upper CI"
  ) 

res %>%
  filter(var_name == "natural log ast") %>%
  dplyr::select(plot_name, estimate, se, test_statistic, 
                p_value, adjusted_pval,conf_low, conf_high)%>%
  gt() %>%
  tab_header(
    title = "Associations between exposures and AST From Simple LR"
  ) %>%
  cols_label(
    plot_name = "PFAS",
    estimate = "Estimate",
    se = "Standard Error",
    test_statistic = "Statistic",
    p_value = "P-value",
    adjusted_pval = "Adjusted P-value",
    conf_low = "Lower CI",
    conf_high = "Upper CI"
  ) 

res %>%
  filter(var_name == "lowest cut alt") %>%
  dplyr::select(plot_name, estimate, se, test_statistic, 
                p_value, adjusted_pval, conf_low, conf_high) %>%
  mutate(
    estimate = exp(estimate),
    conf_low = exp(conf_low),
    conf_high = exp(conf_high)
  ) %>%
  gt() %>%
  tab_header(
    title = "Associations between exposures and ALT (defined by 29 in males and 19 in females) From Logistic Regression"
  ) %>%
  cols_label(
    plot_name = "PFAS",
    estimate = "Odds Ratio",
    se = "Standard Error",
    test_statistic = "Statistic",
    p_value = "P-value",
    adjusted_pval = "Adjusted P-value",
    conf_low = "Lower CI",
    conf_high = "Upper CI"
  ) %>%
  fmt_number(
    columns = vars(estimate, se, conf_low, conf_high),
    decimals = 3
  ) %>%
  fmt_number(
    columns = vars(p_value, adjusted_pval),
    decimals = 3,
    pattern = "{x}"
  ) %>%
  fmt_number(
    columns = vars(p_value, adjusted_pval),
    decimals = 3
  )

res %>%
  filter(var_name == "lowest cut ast") %>%
  dplyr::select(plot_name, estimate, se, test_statistic, 
                p_value, adjusted_pval, conf_low, conf_high) %>%
  mutate(
    estimate = exp(estimate),
    conf_low = exp(conf_low),
    conf_high = exp(conf_high)
  ) %>%
  gt() %>%
  tab_header(
    title = "Associations between exposures and AST (defined by 29 in males and 19 in females) From Logistic Regression"
  ) %>%
  cols_label(
    plot_name = "PFAS",
    estimate = "Odds Ratio",
    se = "Standard Error",
    test_statistic = "Statistic",
    p_value = "P-value",
    adjusted_pval = "Adjusted P-value",
    conf_low = "Lower CI",
    conf_high = "Upper CI"
  ) %>%
  fmt_number(
    columns = vars(estimate, se, conf_low, conf_high, p_value, adjusted_pval),
    decimals = 3
  )

res %>%
  filter(var_name == "highest cut alt") %>%
  dplyr::select(plot_name, estimate, se, test_statistic, 
                p_value, adjusted_pval, conf_low, conf_high) %>%
  mutate(
    estimate = exp(estimate),
    conf_low = exp(conf_low),
    conf_high = exp(conf_high)
  ) %>%
  gt() %>%
  tab_header(
    title = "Associations between exposures and ALT (defined by 33 in males and 25 in females) From Logistic Regression"
  ) %>%
  cols_label(
    plot_name = "PFAS",
    estimate = "Odds Ratio",
    se = "Standard Error",
    test_statistic = "Statistic",
    p_value = "P-value",
    adjusted_pval = "Adjusted P-value",
    conf_low = "Lower CI",
    conf_high = "Upper CI"
  ) %>%
  fmt_number(
    columns = vars(estimate, se, conf_low, conf_high, p_value, adjusted_pval),
    decimals = 3
  )

res %>%
  filter(var_name == "highest cut ast") %>%
  dplyr::select(plot_name, estimate, se, test_statistic, 
                p_value, adjusted_pval, conf_low, conf_high) %>%
  mutate(
    estimate = exp(estimate),
    conf_low = exp(conf_low),
    conf_high = exp(conf_high)
  ) %>%
  gt() %>%
  tab_header(
    title = "Associations between exposures and AST (defined by 33 in males and 25 in females) From Logistic Regression"
  ) %>%
  cols_label(
    plot_name = "PFAS",
    estimate = "Odds Ratio",
    se = "Standard Error",
    test_statistic = "Statistic",
    p_value = "P-value",
    adjusted_pval = "Adjusted P-value",
    conf_low = "Lower CI",
    conf_high = "Upper CI"
  ) %>%
  fmt_number(
    columns = vars(estimate, se, conf_low, conf_high, p_value, adjusted_pval),
    decimals = 3
  )

```
