---
title: 'STRIVE'
subtitle: "Final Analysis"
author: "Hongxu Wang"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    code_folding: hide
editor_options: 
  chunk_output_type: console
---
```{r setup mixture analysis, include=FALSE, echo=FALSE}
options(knitr.table.format = "html")
knitr::opts_chunk$set(echo = TRUE,warning=FALSE, message = FALSE, cache=FALSE,collapse=FALSE)

source(fs::path(here::here("!libraries.R")))
source(fs::path(here::here("!directories.R")))
# source(fs::path(here::here("functions.R")))
source(fs::path(here::here("!load_cleaned_data.R")))
```

## Mixture analysis
```{r ast alt outcomes}
# Set seed for reproducibility
set.seed(1234)
con_end <-c("log_alt", "log_ast")
con_end1 <-c("alt_cat1", "alt_cat2", "ast_cat1", "ast_cat2")
# Prepare the data
data_scaled_analysis <- data %>% 
  drop_na(all_of(con_end), all_of(covars)) %>%
  mutate_at(.vars = con_end1,
            .funs = ~ifelse(. == "Normal", 0, 1))

# Perform OWAS analysis using qgcomp on legacy PFAS
res_legacy_cont <- data.frame()
for(q in 3:6){
  res_temp <- epiomics::owas_qgcomp(data_scaled_analysis,
                                     expnms = legacy_scld,
                                     omics = con_end,
                                     covars = covars,
                                     family = "gaussian",  # Gaussian for linear regression
                                     q = q)%>%
    mutate(parameter = paste0("q = ", q))%>%
    dplyr::select(parameter, everything())
  res_legacy_cont <- res_legacy_cont %>% bind_rows(res_temp)
}

res_legacy_cat <- data.frame()
for(q in 3:6){
  res_temp <- epiomics::owas_qgcomp(data_scaled_analysis,
                                     expnms = legacy_scld,
                                     omics = con_end1,
                                     covars = covars,
                                     family = "binomial", 
                                     q = q)%>%
    mutate(parameter = paste0("q = ", q))%>%
    dplyr::select(parameter, everything())
  res_legacy_cat <- res_legacy_cat %>% bind_rows(res_temp)
}


res_legacy <- res_legacy_cont %>% 
  mutate(outcome_type = "continuous") %>%
  bind_rows(res_legacy_cat %>% 
              mutate(outcome_type = "categorical"))%>%
  mutate(coef = psi,
         ci_low = lcl_psi,
         ci_high = ucl_psi) %>%
  mutate(type = "legacy_pfas") %>%
  dplyr::select(type, everything()) %>%
  mutate(coef_ci = jag2::effest_ci(coef, ci_low, ci_high, n.digits = 3)) %>%
  dplyr::select(parameter, type, coef_ci, everything())%>%
  mutate(sig = case_when((p_value < 0.05 & adjusted_pval < 0.05) ~
                           "Sig.(FDR < 0.05)",
                          p_value < 0.05 ~ "Sig.(p value < 0.05)", 
                         p_value >= 0.05 ~ "Not Sig."))

# Perform OWAS analysis using qgcomp on emerging PFAS
res_emerging_cont <- data.frame()

for(q in 6){
  res_temp <- epiomics::owas_qgcomp(data_scaled_analysis,
                                       expnms = emerging_scld,
                                       omics = con_end,
                                       covars = covars,
                                       family = "gaussian",  
                                       q = q) %>%
    mutate(parameter = paste0("q = ", q)) %>%
    dplyr::select(parameter, everything())
  res_emerging_cont <- res_emerging_cont %>% bind_rows(res_temp)
}

res_emerging_cat <- data.frame()

for(q in 3:6){
  res_temp <- epiomics::owas_qgcomp(data_scaled_analysis,
                                       expnms = emerging_scld,
                                       omics = con_end1,
                                       covars = covars,
                                       family = "binomial", 
                                       q = q) %>%
    mutate(parameter = paste0("q = ", q)) %>%
    dplyr::select(parameter, everything())
  res_emerging_cat <- res_emerging_cat %>% bind_rows(res_temp)
  }

res_emerging <- res_emerging_cont %>% 
  mutate(outcome_type = "continuous") %>% 
  bind_rows(res_emerging_cat %>% 
              mutate(outcome_type = "categorical"))%>%
  mutate(coef = psi,
         ci_low = lcl_psi,
         ci_high = ucl_psi) %>%
  mutate(type = "emerging_pfas") %>%
  dplyr::select(type, everything()) %>%
  mutate(coef_ci = jag2::effest_ci(coef, ci_low, ci_high, n.digits = 3)) %>%
  dplyr::select(parameter, type, coef_ci, everything())%>%
  mutate(sig = case_when((p_value < 0.05 & adjusted_pval < 0.05) ~
                           "Sig.(FDR < 0.05)",
                          p_value < 0.05 ~ "Sig.(p value < 0.05)", 
                         p_value >= 0.05 ~ "Not Sig."))

# Bind results for bar plot
res <- res_legacy %>% 
  dplyr::select(parameter:adjusted_pval, outcome_type) %>% 
  bind_rows(res_emerging %>% 
              dplyr::select(parameter:adjusted_pval, outcome_type)) 

writexl::write_xlsx(res, fs::path(dir_result,
                                  "mixture_analysis_alt_ast_outcomes.xlsx"))

# Transform coefficients and confidence intervals to OR for categorical results
transform_to_or <- function(df) {
  df %>%
    mutate(
      coef = exp(coef),
      ci_low = exp(ci_low),
      ci_high = exp(ci_high)
    )
}

# Plotting function
plot_pfas <- function(res, title, is_categorical = FALSE) {
  if (is_categorical) {
    res <- transform_to_or(res)
    x_label <- "Odds Ratio (95% CI)"
  } else {
    x_label <- "Coefficient (95% CI)"
  }
  
res$feature<-factor(res$feature, levels=c("log_alt", "log_ast", "alt_cat1", "alt_cat2", "ast_cat1", "ast_cat2"), labels=c("natural log alt", "natural log ast", "lowest cut alt", "highest cut alt", "lowest cut ast", "highest cut ast"))

  ggplot(res, aes(x = coef, y = fct_reorder(feature, coef), color = sig)) +
    geom_errorbar(aes(xmin = ci_low, xmax = ci_high), width = 0, position = position_dodge(width = 1)) +
    geom_point(size = 1, position = position_dodge(width = 1)) + 
    geom_vline(xintercept = if (is_categorical) 1 else 0, linetype = 2, color = "grey") + 
    facet_grid(~parameter, scales = "free_x") + 
    labs(
      title = title,
      x = x_label, 
      y = "PFAS"
    ) +
    theme(
      legend.position = "bottom",
      panel.background = element_rect(fill = "white"), 
      strip.background = element_rect(fill = "white"),
      strip.text.y = element_text(angle = 0, hjust = 0),
      text = element_text(size = 15),
      axis.title.y = element_blank(),
      axis.line.x = element_line(color = "black"),
      axis.line.y = element_line(color = "black"),
      plot.title = element_text(size = 15, hjust = 0.5)
    ) +
    scale_color_manual(values = c("black", "red"))
}

# Plot results for legacy PFAS
plot_legacy_cat <- plot_pfas(res_legacy %>% filter(outcome_type == "categorical"), "Effect of Legacy PFAS on outcomes", TRUE)
plot_legacy_cont <- plot_pfas(res_legacy %>% filter(outcome_type == "continuous"), "Effect of Legacy PFAS on outcomes")

# Plot results for emerging PFAS
plot_emerging_cat <- plot_pfas(res_emerging %>% filter(outcome_type == "categorical"), "Effect of Emerging PFAS on outcomes", TRUE)
plot_emerging_cont <- plot_pfas(res_emerging %>% filter(outcome_type == "continuous"), "Effect of Emerging PFAS on outcomes")

# Print plots
print(plot_legacy_cont)
print(plot_emerging_cont)
print(plot_legacy_cat)
print(plot_emerging_cat)

```


# Tables: adjusted association of PFAS mixture with outcomes
```{r mixture analysis}
res <- readxl::read_xlsx(fs::path(dir_result,
                                  "mixture_analysis_alt_ast_outcomes.xlsx"))

res %>%
  filter(feature == "log_alt") %>%
  dplyr::select(parameter, type, coef_ci, test_statistic, 
                p_value, adjusted_pval)%>%
  gt() %>%
  tab_header(
    title = "Associations between PFAS mixture and ALT From qgcomp"
  ) %>%
  cols_label(
    parameter = "Parameter",
    type = "PFAS mixture",
    coef_ci = "Effect Estimate (95% CI)",
    test_statistic = "Statistic",
    p_value = "P-value",
    adjusted_pval = "Adjusted P-value",
  ) 

res %>%
  filter(feature == "log_ast") %>%
   dplyr::select(parameter, type, coef_ci, test_statistic, 
                p_value, adjusted_pval)%>%
  gt() %>%
  tab_header(
    title = "Associations between PFAS mixture and AST From qgcomp"
  ) %>%
  cols_label(
    parameter = "Parameter",
    type = "PFAS mixture",
    coef_ci = "Effect Estimate (95% CI)",
    test_statistic = "Statistic",
    p_value = "P-value",
    adjusted_pval = "Adjusted P-value",
  ) 

##
res %>%
  filter(feature == "alt_cat1") %>%
  mutate(
    OR = exp(psi),
    lower_CI = exp(lcl_psi),
    upper_CI = exp(ucl_psi),
    coef_ci = paste0(round(OR, 3), " (", round(lower_CI, 3), "-", round(upper_CI, 3), ")")
  )%>%
  dplyr::select(parameter, type, coef_ci, test_statistic, 
                p_value, adjusted_pval) %>%
  gt() %>%
  tab_header(
    title = "Associations between PFAS mixture and ALT (defined by 29 in males and 19 in females) From qgcomp"
  ) %>%
  cols_label(
    parameter = "Parameter",
    type = "PFAS mixture",
    coef_ci = "Effect Estimate (95% CI)",
    test_statistic = "Statistic",
    p_value = "P-value",
    adjusted_pval = "Adjusted P-value"
  ) %>%
  fmt_number(
    columns = vars(test_statistic, p_value, adjusted_pval),
    decimals = 3
  )


res %>%
  filter(feature == "ast_cat1") %>%
  mutate(
    OR = exp(psi),
    lower_CI = exp(lcl_psi),
    upper_CI = exp(ucl_psi),
    coef_ci = paste0(round(OR, 3), " (", round(lower_CI, 3), "-", round(upper_CI, 3), ")")
  ) %>%
  dplyr::select(parameter, type, coef_ci, test_statistic, 
                p_value, adjusted_pval) %>%
  gt() %>%
  tab_header(
    title = "Associations between PFAS mixture and AST (defined by 29 in males and 19 in females) From qgcomp"
  ) %>%
  cols_label(
    parameter = "Parameter",
    type = "PFAS mixture",
    coef_ci = "Effect Estimate (95% CI)",
    test_statistic = "Statistic",
    p_value = "P-value",
    adjusted_pval = "Adjusted P-value"
  ) %>%
  fmt_number(
    columns = vars(test_statistic, p_value, adjusted_pval),
    decimals = 3
  )

res %>%
  filter(feature == "alt_cat2") %>%
  mutate(

    OR = exp(psi),
    lower_CI = exp(lcl_psi),
    upper_CI = exp(ucl_psi),
    coef_ci = paste0(round(OR, 3), " (", round(lower_CI, 3), "-", round(upper_CI, 3), ")")
  ) %>%
  dplyr::select(parameter, type, coef_ci, test_statistic, 
                p_value, adjusted_pval) %>%
  gt() %>%
  tab_header(
    title = "Associations between PFAS mixture and ALT (defined by 33 in males and 25 in females) From qgcomp"
  ) %>%
  cols_label(
    parameter = "Parameter",
    type = "PFAS mixture",
    coef_ci = "Effect Estimate (95% CI)",
    test_statistic = "Statistic",
    p_value = "P-value",
    adjusted_pval = "Adjusted P-value"
  ) %>%
  fmt_number(
    columns = vars(test_statistic, p_value, adjusted_pval),
    decimals = 3
  )

res %>%
  filter(feature == "ast_cat2") %>%
  mutate(

    OR = exp(psi),
    lower_CI = exp(lcl_psi),
    upper_CI = exp(ucl_psi),
    coef_ci = paste0(round(OR, 3), " (", round(lower_CI, 3), "-", round(upper_CI, 3), ")")
  ) %>%
  dplyr::select(parameter, type, coef_ci, test_statistic, 
                p_value, adjusted_pval) %>%
  gt() %>%
  tab_header(
    title = "Associations between PFAS mixture and AST (defined by 33 in males and 25 in females) From qgcomp"
  ) %>%
  cols_label(
    parameter = "Parameter",
    type = "PFAS mixture",
    coef_ci = "Effect Estimate (95% CI)",
    test_statistic = "Statistic",
    p_value = "P-value",
    adjusted_pval = "Adjusted P-value"
  ) %>%
  fmt_number(
    columns = vars(test_statistic, p_value, adjusted_pval),
    decimals = 3
  )

```
