---
title: 'STRIVE'
subtitle: "Descriptive Stats"
author: "Hongxu Wang"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, echo=FALSE}
options(knitr.table.format = "html")
knitr::opts_chunk$set(echo = TRUE)

source(fs::path(here::here("!libraries.R")))
source(fs::path(here::here("!directories.R")))
source(fs::path(here::here("!load_cleaned_data.R")))
```


```{r data summary,warning=FALSE}
#data1 <- data %>% drop_na(case_control) %>% dyplr::select(-strive_id,-contains("scld")) %>%
 # mutate_at(.vars = covars[-2],
  #          .funs = ~ as.character(.))
# 
# table1::table1(~.|case_control, data1)
```

# Check percentage of NA for each PFAS
```{r percentage of NA, warning=FALSE}
data_pfas<- data %>% dplyr::select(pfas_name, case_control, -contains("scld"))

## Stats----
pfas_na <- data_pfas %>% 
  pivot_longer(cols = pfas_name) %>%
  group_by(name) %>%
  dplyr::summarize(pct_na = sum(is.na(value))/dim(data_pfas)[1])%>%
  ungroup()%>%
  arrange(pct_na)

# print all rows
print(pfas_na, n=25)

# writexl::write_xlsx(pfas_na,
#                     fs::path(dir_result,
#                              "percent of na for PFAS.xlsx"))

```

# Descriptive stats of PFAS in overall paricipants
```{r descriptive stats for pfas, warning=FALSE}
data_pfas<- data %>% dplyr::select(pfas_name_analysis, case_control)

## Stats----
(pfas_stats <- data_pfas %>% 
  pivot_longer(cols = pfas_name_analysis) %>%
  drop_na() %>%
  group_by(name) %>%
  dplyr::summarise(
    geometric_mean = jag2::fungm(value),
    sd = jag2::fungsd(value),
    min = min(value),
    max = max(value),
    percentile_25 = jag2::qntle_fxn(value, 0.25),
    percentile_50 = jag2::qntle_fxn(value, 0.5),
    percentile_75 = jag2::qntle_fxn(value, 0.75),
    percentile_90 = jag2::qntle_fxn(value, 0.90)
  ) %>% 
  ungroup())

#writexl::write_xlsx(pfas_stats,
 #                   fs::path(dir_result,
     #                        "descriptive_stats_pfas.xlsx"))
```

# Descriptive stats split by outcome
```{r stats,warning=FALSE, cache=FALSE}
covars <- c("source", "age_at_enrollment","sex", 
            "race_eth_label", "race_final_label","ethnicity",
            "rural", "smoking","sq_drink_alcohol","sq_average_drink_per_day","sq_self_hep_b",
            "sq_self_hep_c","supp_meds_tylenol","supp_meds_steroids","sq_water_well",
            "sq_water_tap_unfiltered","sq_water_house_filtration", "sq_water_faucet_filter",
            "sq_water_charcoal_filter","sq_water_bottled","sq_water_none","sq_water_other_type")

(data %>% dplyr::select(pfas_name_analysis, covars,race_final_label,
                  ethnicity,contains("sq_"),contains("alt"), 
                  contains("ast"), contains("trig"),cirrhosis,
                  case_control) %>%
  tbl_summary(by = case_control,
              type = all_continuous() ~ "continuous2",
              statistic = list(
                               all_continuous() ~ c("{mean} ({sd})",
                                                    "{median} ({p25}, {p75})"),
                               all_categorical() ~ "{n} ({p}%)")) %>%
  add_p(pvalue_fun = ~ style_pvalue(.x, digits = 2)) %>%
  add_overall() %>%
  add_n())
```

# Correlation between PFAS and potential confounders
```{r}
covars <- c("source", "age_at_enrollment","sex", 
            "race_eth_label", "race_final_label","ethnicity",
            "rural", "smoking","sq_drink_alcohol","sq_average_drink_per_day","sq_self_hep_b",
            "sq_self_hep_c","supp_meds_tylenol","supp_meds_steroids","sq_water_well",
            "sq_water_tap_unfiltered","sq_water_house_filtration", "sq_water_faucet_filter",
            "sq_water_charcoal_filter","sq_water_bottled","sq_water_none","sq_water_other_type")

# Function to perform linear model for all potential confounders
test_lm <- function(df, pfas, covar) {
  result <- tryCatch({
    model <- lm(as.formula(paste(pfas, "~", covar)), data = df)
    tidy(model)
  }, error = function(e) {
    tibble(term = covar, estimate = NA, std.error = NA, statistic = NA, p.value = NA)
  })
  result
}

# Performing the tests and collecting results
results <- list()

for (pfas in pfas_name_analysis) {
  for (covar in covars) {
    result <- test_lm(data, pfas, covar)
    result <- result %>%
      filter(term != "(Intercept)") %>%  # remove intercept term from results
      mutate(pfas = pfas, covariate = covar)
    results <- append(results, list(result))
  }
}

# Combine results into a single data frame
results_df <- bind_rows(results) %>%
  dplyr::select(pfas, term, everything(), -covariate)

# Filter for significant results
significant_results <- results_df %>%
  filter(p.value < 0.05)

print(significant_results)

# Create a formatted table using gt
significant_results %>%
  gt() %>%
  tab_header(
    title = "Significant Associations between PFAS and potential confounders From Simple LR"
  ) %>%
  cols_label(
    pfas = "PFAS",
    term = "Covariate",
    estimate = "Estimate",
    std.error = "Standard Error",
    statistic = "Statistic",
    p.value = "P-value"
  ) %>%
  fmt_number(
    columns = c(estimate, std.error, statistic, p.value),
    decimals = 3
  ) %>%
  tab_source_note(
    source_note = "Significant results with p-value < 0.05"
  )

```

# Correlation between exposure/potential confounders and AST/ALT
```{r}
covars <- c("source", "age_at_enrollment","sex", 
            "race_eth_label", "race_final_label","ethnicity",
            "rural", "smoking","sq_drink_alcohol","sq_average_drink_per_day","sq_self_hep_b",
            "sq_self_hep_c","supp_meds_tylenol","supp_meds_steroids","sq_water_well",
            "sq_water_tap_unfiltered","sq_water_house_filtration", "sq_water_faucet_filter",
            "sq_water_charcoal_filter","sq_water_bottled","sq_water_none","sq_water_other_type")

combined_exp <- c(pfas_name_analysis, covars)

# Function to perform linear model for all potential confounders
ast_alt_lm <- function(df, exp,out) {
  result <- tryCatch({
    model <- lm(as.formula(paste(out, "~", exp)), data = df)
    tidy(model)
  }, error = function(e) {
    tibble(term = exp, estimate = NA, std.error = NA, statistic = NA, p.value = NA)
  })
  result
}

# Performing the tests and collecting results
results <- list()
outcome <- c("`AST/ALT`")

for (x_var in combined_exp) {
  
    result <- ast_alt_lm(data, x_var,outcome)
    result <- result %>%
      filter(term != "(Intercept)") %>%  # remove intercept term from results
      mutate(Exposure = x_var)
    results <- append(results, list(result))
  
}


# Combine results into a single data frame
results_df <- bind_rows(results) %>%
  dplyr::select(everything(), -Exposure)

# Filter for significant results
#significant_results <- results_df %>%
 # filter(p.value < 0.05)

#print(significant_results)

# Create a formatted table using gt
results_df %>%
  gt() %>%
  tab_header(
    title = "Associations between exposures and AST/ALT Ratio From Simple LR"
  ) %>%
  cols_label(
   
    term = "Variables",
    estimate = "Estimate",
    std.error = "Standard Error",
    statistic = "Statistic",
    p.value = "P-value"
  ) %>%
  fmt_number(
    columns = c(estimate, std.error, statistic, p.value),
    decimals = 3
  ) %>%
  tab_source_note(
    source_note = "Significant results with p-value < 0.05"
  )

```

