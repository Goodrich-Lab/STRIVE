---
title: 'STRIVE'
subtitle: "Descriptive Stats"
author: "Hongxu Wang"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, echo=FALSE}
options(knitr.table.format = "html")
knitr::opts_chunk$set(echo = TRUE)

source(fs::path(here::here("!libraries.R")))
source(fs::path(here::here("!directories.R")))
source(fs::path(here::here("!load_cleaned_data.R")))
```


```{r data summary,warning=FALSE}
data <- readxl::read_xlsx(fs::path(
  dir_data,
  "STRIVE_PFAS_demo_28jun24.xlsx")) %>% 
  janitor::clean_names()%>%
  mutate(sex = ifelse(sex == 1, "Male", "Female"),
         rural = ifelse(rural == 1, "Living in rural area", "Living in Metro area"),
         smoking = ifelse(smoking == 1, "Smoke or use vape", "Don't smoke or use vape"),
         case_control = ifelse(case_control == 1, "With cirrhosis", "Healthy"),
         ## added by BS
         ethnicity = ifelse(ethnicity == 1, "Hispanic", "Not Hispanic"),
         sq_drink_alcohol = case_when(
           sq_drink_alcohol == 1 ~ "Yes, current drinker",
           sq_drink_alcohol == 2 ~ "No, former drinker (stopped)",
           sq_drink_alcohol == 3 ~ "No, never drinker",
           TRUE ~ "Unknown/Not Reported"), 
         sq_average_drink_per_day = case_when(
             sq_average_drink_per_day == 1 ~ "Less than 1 alcoholic drink per day",
             sq_average_drink_per_day == 2 ~ "1-2 alcoholic drinks per day",
             sq_average_drink_per_day == 3 ~ "3-4 alcoholic drinks per day",
             sq_average_drink_per_day == 4 ~ "More than 4 alcoholic drinks per day",
             TRUE ~ "Unknown/Not Reported"
           )
         ## to here 
         
         )%>%
  mutate(rural = ifelse(is.na(rural), "Unknown/Not Reported", rural),
         smoking = ifelse(is.na(smoking), "Unknown/Not Reported", smoking))%>%
  ## added or edited by BS
  mutate(race_eth_label = ifelse(is.na(race_eth_label), "Unknown/Not Reported", race_eth_label),
         race_final_label = ifelse(is.na(race_final_label), "Unknown/Not Reported", race_final_label),
         sq_average_drink_per_day = ifelse(is.na(sq_average_drink_per_day), "Unknown/Not Reported", sq_average_drink_per_day))

```

# Check percentage of NA for each PFAS
```{r percentage of NA, warning=FALSE}
data_pfas<- data %>% dplyr::select(pfas_name, case_control, -contains("scld"))

## Stats----
pfas_na <- data_pfas %>% 
  pivot_longer(cols = pfas_name) %>%
  group_by(name) %>%
  dplyr::summarize(pct_na = sum(is.na(value))/dim(data_pfas)[1])%>%
  ungroup()%>%
  arrange(pct_na)

# print all rows
print(pfas_na, n=25)

# writexl::write_xlsx(pfas_na,
#                     fs::path(dir_result,
#                              "percent of na for PFAS.xlsx"))

pfas_name_analysis <- pfas_na$name[1:12] # by the cutoff of 25% of missing

```

# Descriptive stats of PFAS in overall paricipants
```{r descriptive stats for pfas, warning=FALSE}
data_pfas<- data %>% dplyr::select(pfas_name_analysis, case_control)

## Stats----
(pfas_stats <- data_pfas %>% 
  pivot_longer(cols = pfas_name_analysis) %>%
  drop_na() %>%
  group_by(name) %>%
  dplyr::summarise(
    geometric_mean = jag2::fungm(value),
    sd = jag2::fungsd(value),
    min = min(value),
    max = max(value),
    percentile_25 = jag2::qntle_fxn(value, 0.25),
    percentile_50 = jag2::qntle_fxn(value, 0.5),
    percentile_75 = jag2::qntle_fxn(value, 0.75),
    percentile_90 = jag2::qntle_fxn(value, 0.90)
  ) %>% 
  ungroup())

# writexl::write_xlsx(pfas_stats,
#                     fs::path(dir_result,
#                              "descriptive_stats_pfas.xlsx"))
```

# Descriptive stats split by outcome
```{r stats,warning=FALSE, cache=FALSE}
(data %>% dplyr::select(pfas_name_analysis, covars,race_final_label,
                  ethnicity,contains("sq_"),contains("alt"), 
                  contains("ast"), contains("trig"),
                  case_control) %>%
  tbl_summary(by = case_control,
              type = all_continuous() ~ "continuous2",
              statistic = list(
                               all_continuous() ~ c("{mean} ({sd})",
                                                    "{median} ({p25}, {p75})"),
                               all_categorical() ~ "{n} ({p}%)")) %>%
  add_p(pvalue_fun = ~ style_pvalue(.x, digits = 2)) %>%
  add_overall() %>%
  add_n())
```

